# Documentation

## Concepts

A report is a generated markdown file (and soon might be html or json).  A report has many sections.  A section and it's data is generated by crawling issues from a project board's cards or a repositories issues (known as targets).  For that reason, there are "project" reports and "repo" reports.  A project report for example expects data from a project board (and it's stages).

Project board reports report on the life cycle of work (a card) as it moves through `stages`.  The logical stages are pre-defined for report authors but map to physical columns from a board.

```
    Proposed => Accepted => In-Progress => Done
```

Each of those stages can map to physical columns on your board.  Each stage can map to one or more physical columns on your board.  The time for each stage is recorded as the first time it entered that stage from a previous stage or no stage.  For example, if it moved from accepted to in progress on date 1, then to Done on date 2 and back to in progress on date 3, it has been in progress since date 1.

If a report section targets multiple targets, the data will be rolled up and passed to the report.  Since the stages and times are normalized, it can provide a common view of different boards and repos.

Reports have default settings but they can be overriden in your configuration file.

Reports will have settings for various labels, but in general using this set will allow for less configuration settings and consistency:

- type: `epic`, `feature`, `task`, `bug`
- status: `status: green`, `status: yellow`, `status: red`

> TODO: I think we should change this to `green`, `yellow`, `red` for alignment with type and being simple

"Last updated" is calculated by default from looking for a comment with the heading text `## update`.  This is customizable.

So let's get started ...

## Create a repo for running and storing your reports

This could be an existing repo but having a separate repo for the reports.  This also allows for securing reports.  The wider the scope, the better the ability to rollup data, share the cache and avoid rate limiting.  Note that the crawler writes a cache of etags so only data that changes between runs is pulled and debited to your rate limits.

## Create a token for accessing 

Create a personal access token that can read repo and project scopes for an identity that has permissions to the projects and repositories you are reporting on.

Add the secret to your repo and give it a name like `PROJECT_TOKEN`.  Documentation is [here](https://docs.github.com/en/actions/configuring-and-managing-workflows/creating-and-storing-encrypted-secrets).

## Using in a workflow

Add the `project-reports-action` after the `'checkout` step.  Specify the secret name in the `token` input and supply a path relative to the root of the repo with your configuration file.

```yaml
jobs:
  run-reports:
    runs-on: ubuntu-18.04
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v2
      - uses: bryanmacfarlane/project-reports-action@v1-alpha3
        with: 
          token: ${{ secrets.PROJECT_TOKEN }}
          configPath: yourconfig.yml
```

## Configuration File

A sample configuration file is in [samples/sample.yaml](../samples/sample.yaml).

A configuration file has:

- **targets**: a target is a project board or a repository that you want to report on.  A target may have settings.  For example, a project board might have the column names   

### Targets

Targets are named references to a project board or repo.  Both have an html url which is the url you see in the browser.  A project target can also have a `columnMap` to map the logical stage to the physical column.

```yaml
name: myconfig

targets:
  quotesFeedRepo:
    type: repo
    htmlUrl: https://github.com/bryanmacfarlane/quotes-feed
  sanenodeRepo:
    type: repo
    htmlUrl: https://github.com/bryanmacfarlane/sanenode    
  todoProject:
    type: project
    htmlUrl: https://github.com/users/bryanmacfarlane/projects/1
    columnMap:
      Proposed: ["In Box"]           # Drafts author is working on.  Has a chance of moving soon
      Accepted: [
        "Up Next",                   # Ready for review
        "Next"]                      # Previous name of column       
      In-Progress: ["In Progress"]   # Work is underway
      Done: ["Complete"]             # Celebrate
```

Give the config file a name (just used for logging etc).  Note: Might remove and just use path.

### Output

Output is the path where the reports and the data generated will be written.

```yaml
output: "_reports"
```

> `Issue`: For now, use path starting with `_reports` as the value.  It will be the relative folder soon.  

### Report definition

A report will generate one markdown file (and related files).  The `name` will be the file on disk created and the `title` will be the heading 1 title header.

`kind` is only supported as markdown.  We may add html and / or json.

`timezoneOffset` is the timezone dates and times will be reported as. 

`targets` is a report section concept but if you supply it at the reports level, it will apply to all sections.  This is the typical case.

```yaml
reports:
  - name: TODO
    title: "My Project Report"
    kind: markdown 
    timezoneOffset: -8
    targets: ['todoProject']
```

### Report Sections

A report is comprised of many sections which actually present the data as tables and lists.

```yaml
reports:
  - name: TODO
...
    sections:
      - name: "project-limits"
        config: 
          report-on-label: '*'
          accepted-limit: 2
          in-progress-limit: 2
          count-label-match: "(\\d+)-dev"
```

Each section references the `name` of a report.

> Important: reports that start with `project-` are project reports and expect a project target.  Reports that start with `repo-` are repository reports and expect a repo target.  The generator will error out with a good message if you mix.  Note that data from a project board has stage data on it like `project_added_at`, `progress-in-progress-at` etc.  Those reports expect that.

The `config` settings are specific to each report.   However, note that each report supplies defaults and you only need to specify what's different from that.

## Built-in Reports

[project-limits](./project-limits.md)  



## Custom Reports

TODO: document and test

